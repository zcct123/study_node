# 查询执行的基础

 ![](/img/屏幕截图%202022-05-05%20205834.png)

1. 客户端大宋一条查询给服务器
2. 服务器先检查缓存，如果命中缓存直接返回，否则进入下一阶段
3. 服务器惊醒sql解析优化、预处理、再由优化器生成对应的执行计划
4. Mysql 根据优化器生成的执行计划，调用存储引擎 api 来执行查询
5. 将结果返回给客户端
   
<br>

## mysql 客户端/服务端通信协议

<br>

   Mysql 客户端和服务端的通信协议是**半双工**的，这意味着在同一时刻要么有服务器向客户端发送数据，要么是客户端向服务器发送数据，这两个动作不会同时发生。

### 查询状态

对于一个mysql连接或者说一个线程，任何时刻都有一个装填，改状态表示了MYSQL当前正在做什么。最简单使用 **SHOW FULL PROCESSLIST** 命令

1. sleep
    
    线程正在等待客户端发送新的请求
2. query

    线程正在执行查询或正在将结果赶回给服务端
3. Locked

    在mysql的服务层，该线程正在等待表锁。 在存储引擎级别实现的锁，例如 innodb的行锁，并不会体现在线程状态中
4. Abalyzing and statisitcs

    线程正在收集存储引擎信息，并生成查询计划

5. Sorting result

    线程正在对结果集排序

6. Sending data

    表示多中情况： 线程可能在多个状态之间传送数据， 或在生成结果集，或向客户端发送数据

<br>

## 查询缓存

<br>

如果缓存是打开的，在解析一个查询语句之前，mysql 会优先检查这个查询是否命中缓存中的数据，这个检查是通过一对大小写敏感的哈希查找实现的，查询和缓存中的查询即使只有一个字节不同，那么他们也不会匹配缓存结果，这种情况下查询就会进入下一个阶段

如果当前查询恰好命中缓存，那么子啊返回结果时会检查一次用户权限，如果权限没有问题，mysql会跳过其他阶段，从缓存中得到结果并返回给客户端

<br>

## 查询优化处理

<br>

将一个 sql  解析成一个执行计划，mysql 按照这个执行计划和存储引擎交互，这包含多个子阶段： 解析 sql、预处理、优化 sql 执行计划

### 语法解析器和预处理

mysql 通过关键字将 sql 语句进行解析 ，并生成一个对应的 “ 解析树 ”， Mysql 解析器将使用mysql 语法规则验证和解析查询。 例如： 是都使用错误的关键字、使用关键字的顺序是否正确、 验证引号使用

预处理器则根据一些mysql 规则进一步检查解析树是否合法，例如：检查表列是否存在，解析名字和别名

### 查询优化器

优化器 解析树 转化成执行计划，一条查询可以有很多种执行方式，优化器就是为了找到最好的执行方式。

mysql使用的是基于成本的优化器，他将尝试预测一个查询使用某种执行计划时的成本，并选择成本最小的哪一个。

可以通过 **Last_query_cost** 的值来的值Mysql计算的当前查询成本







