# 查询性能优化

如果把一个查询看作一个任务，那么他由一系列子任务组成，每一个任务都消耗一定的时间，要优化查询，实际上要优化他的子任务，要么消除一些子任务，要么减少子任务查询的次数
## 优化数据访问
1. 确定应用程序是否在检索大量超过需要的数据
2. mysql服务器曾是否在分析大量超过不要的行

### 1.是否向服务器请求了不需要的数据
有些查询会请求超过实际许愿哦的数据，然后这些福哦与的数据就会被应用程序丢弃，这会给 mysql 带来额外的负担，并增加网络开销，同时页消耗应用服务器的 cpu 和 内存

案例：

1. 查询返回不需要的数据
   先使用select插叙大量数据，但是在页面上只显示前10条，实际情况mysql会查询出全部结果集，客户端也会接受全部的结果集抛弃其中大部分数据，最有效的解决方法就是使用limit
2. 多表关联返回全部列
   ``` sql
        select * from A inner join B USING(id) where
        # 这样会返回两张表的全部列 ， 正确方式应该只是取需要的列
   ```   
3. 总是取出全部列 select * 
    取出全部列会让索引无法完成索引覆盖扫描这类优化，还会给服务器带来额外的 I/O 、内存和 CPU 的消耗
4. 重复查询相同的数据
    不断的执行相同的查询，每次都返回完全相同的数据集。 比较好的方案就是使用缓存


### 2.是否扫描额外的记录
最简单的衡量查询的三个指标：
1. 响应时间
2. 扫描的行数
3. 返回的行数

#### 响应时间
响应时间分为两个部分：服务时间和排队时间，服务时间是指数据库处理这个查询真正花费的时间，排队时间是指服务器因为等待某些资源而没有真正执行查询的时间——可能是等来I/O操作完成，也可能是等待锁。
#### 扫描的行数和返回的行数
扫描的行数在一定程度上能够说明找到需要的数据效率高不高
理想情况下扫描的行数和查询的行数应该是相同的——实际这种情况很少
#### 扫描的行数和访问类型
在评估查询开销时，需要考虑一下从表中找到某一行数据的成本 。有些查询需要扫描很多行才能返回一行结果，也有些访问方式可能无须扫描就能返回结果。


在 EXPLAIN 语句中的type列反应了访问类型。访问类型有很多种，从全表扫描到索引扫描、范围扫描、唯一索引查询、常熟引用等。速度从慢到快，扫描的行数也是从多到少。

## 重构查询方式
### 一个复杂查询还是多个简单的查询
设计查询时一个需要考虑的问题，是否需要将一个复杂的查询分成多个简单的查询。在传统视线中，总是强盗需要数据库蹭尽可能多的工作，这样做的逻辑在于以前总是认为网络通信、查询解析和优化是一件代价很高的事。

但是这些在mysql上并不使用，Mysql从设计上让链接和断开连接都很轻量级，返回一个小的查询和搞笑。而且现代网络带宽和延迟都比以前快的多。所以运行多个小查询已经不是大问题。
### 切分查询
有时候对于大查询需要切分查询，经大查询切分成小查询，每个查询功能完全一样，只完成小部分，每次只返回一小部结果。

例如删除旧数据时，定期清理大量数据时，如果一个大的语句一次性完成，可能锁住很多的数据，占满真个事务日志，耗尽系统资源、阻塞住很小的但很重要的拆线呢。
### 分解关联查询
可以对每一个表进行一次单表查询，染回将结果在应用程序中进行关联。
优势：
* 让缓存效率更高。
* 执行单个查询减少锁的竞争
* 在应用层关联，可以很容易对数据库做差分，更用以做到高性能和可扩展
* 查询性能本身也会提升
* 可以减少冗余记录的查询，在数据库关联查询时，可能重复访问一部分数据
  

